// ============================================
// SISTEMA DE GESTÃO MR. CHRONO
// Schema Prisma - PostgreSQL
// ============================================

generator client {
  provider     = "prisma-client"
  output       = "./generated/client"
  moduleFormat = "esm"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum NivelAcesso {
  ADMINISTRADOR
  SOCIO
  FUNCIONARIO
}

enum TipoPessoa {
  PESSOA_FISICA
  PESSOA_JURIDICA
}

enum OrigemTipo {
  COMPRA
  CONSIGNACAO
}

enum OrigemCanal {
  PESSOA_FISICA
  LEILAO_BRASIL
  EBAY
}

enum StatusPeca {
  DISPONIVEL
  EM_TRANSITO
  REVISAO
  VENDIDA
  DEFEITO
  PERDA
}

enum ScoreFornecedor {
  EXCELENTE
  BOM
  REGULAR
  RUIM
}

enum FormaPagamento {
  PIX
  CREDITO_VISTA
  CREDITO_PARCELADO
}

enum StatusPagamento {
  PAGO
  PARCIAL
  NAO_PAGO
}

enum StatusRepasse {
  FEITO
  PARCIAL
  PENDENTE
}

enum TipoAlerta {
  ESTOQUE_BAIXO
  RELOJOEIRO_DEMORADO
  REPASSE_PENDENTE
}

// ============================================
// ENUMS — MÓDULO FINANCEIRO
// ============================================

enum TipoConta {
  GRUPO
  SUBGRUPO
  ANALITICA
}

enum NaturezaConta {
  DEVEDORA
  CREDORA
}

enum TipoLancamento {
  MANUAL
  AUTOMATICO_VENDA
  AUTOMATICO_DESPESA_RECORRENTE
  TRANSFERENCIA
  DISTRIBUICAO_LUCROS
  ANTECIPACAO
}

enum StatusDespesaRecorrente {
  ATIVA
  INATIVA
}

enum StatusEnvio {
  PENDENTE
  ENVIADO
  ENTREGUE
}

// ============================================
// AUDITORIA
// ============================================

model Auditoria {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  acao       String // CRIAR, EDITAR, EXCLUIR, etc.
  entidade   String // PECA, VENDA, CLIENTE, etc.
  entidadeId String? // ID do registro afetado
  detalhes   String? // JSON com dados adicionais
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entidade])
  @@index([createdAt])
  @@map("auditorias")
}

// ============================================
// FORNECEDORES
// ============================================

model Fornecedor {
  id          String           @id @default(cuid())
  tipo        TipoPessoa
  nome        String
  cpfCnpj     String           @unique
  telefone    String
  email       String?
  // Endereço
  cep         String
  rua         String
  numero      String
  complemento String?
  bairro      String
  cidade      String
  estado      String           @db.Char(2)
  score       ScoreFornecedor?
  arquivado   Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relações
  pecas Peca[]

  @@index([cpfCnpj])
  @@index([arquivado])
  @@map("fornecedores")
}

// ============================================
// CLIENTES
// ============================================

model Cliente {
  id             String     @id @default(cuid())
  tipo           TipoPessoa
  nome           String
  cpfCnpj        String     @unique
  dataNascimento DateTime? // Obrigatório se PF
  telefone       String
  email          String?
  // Endereço
  cep            String
  rua            String
  numero         String
  complemento    String?
  bairro         String
  cidade         String
  estado         String     @db.Char(2)
  arquivado      Boolean    @default(false)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Relações
  vendas Venda[]

  @@index([cpfCnpj])
  @@index([arquivado])
  @@map("clientes")
}

// ============================================
// PEÇAS (ESTOQUE)
// ============================================

model Peca {
  id               String      @id @default(cuid())
  // SKU
  sku              String      @unique
  skuBase          String // SKU original (sem sufixo de devolução)
  numeroDevolucoes Int         @default(0)
  // Dados do relógio
  marca            String
  modelo           String
  ano              Int?
  tamanhoCaixa     Float // em mm
  materialCaixa    String?
  materialPulseira String?
  // Valores
  valorCompra      Decimal     @db.Decimal(10, 2)
  valorEstimadoVenda Decimal   @db.Decimal(10, 2)
  custoManutencao    Decimal?  @db.Decimal(10, 2) // Revisão relojoeiro + restauro mostrador (entra no CMV)
  // Origem
  origemTipo       OrigemTipo
  origemCanal      OrigemCanal?
  valorRepasse     Decimal?    @db.Decimal(10, 2) // Para consignação (valor fixo)
  percentualRepasse Float?     // Ex: 10.5 para 10,5% do valor final da venda
  // Pagamento ao fornecedor (para compras diretas)
  statusPagamentoFornecedor StatusPagamento @default(NAO_PAGO)
  valorPagoFornecedor       Decimal         @default(0) @db.Decimal(10, 2)
  dataPagamentoFornecedor   DateTime?       // Data do último pagamento
  // Status e localização
  status           StatusPeca  @default(EM_TRANSITO)
  localizacao      String      @default("Fornecedor")
  // Controle
  arquivado        Boolean     @default(false)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  // Catálogo público
  exibirNoCatalogo Boolean     @default(true)
  pinnedInCatalog  Boolean     @default(false)
  pinnedAt         DateTime?

  // Relações
  fornecedorId           String
  fornecedor             Fornecedor              @relation(fields: [fornecedorId], references: [id])
  fotos                  Foto[]
  historicoStatus        HistoricoStatus[]
  venda                  Venda?
  pagamentosFornecedor   PagamentoFornecedor[]

  @@index([sku])
  @@index([status])
  @@index([localizacao])
  @@index([arquivado])
  @@index([fornecedorId])
  @@index([statusPagamentoFornecedor])
  @@index([pinnedInCatalog])
  @@map("pecas")
}

// ============================================
// FOTOS DAS PEÇAS
// ============================================

model Foto {
  id        String   @id @default(cuid())
  url       String
  ordem     Int      @default(0)
  pecaId    String
  peca      Peca     @relation(fields: [pecaId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([pecaId])
  @@map("fotos")
}

// ============================================
// HISTÓRICO DE STATUS DAS PEÇAS
// ============================================

model HistoricoStatus {
  id                  String      @id @default(cuid())
  pecaId              String
  peca                Peca        @relation(fields: [pecaId], references: [id], onDelete: Cascade)
  statusAnterior      StatusPeca?
  statusNovo          StatusPeca
  localizacaoAnterior String?
  localizacaoNova     String?
  userId              String?
  user                User?       @relation(fields: [userId], references: [id])
  createdAt           DateTime    @default(now())

  @@index([pecaId])
  @@index([createdAt])
  @@map("historico_status")
}

// ============================================
// VENDAS
// ============================================

model Venda {
  id              String          @id @default(cuid())
  // Peça vendida (1:1)
  pecaId          String          @unique
  peca            Peca            @relation(fields: [pecaId], references: [id])
  // Cliente
  clienteId       String
  cliente         Cliente         @relation(fields: [clienteId], references: [id])
  // Valores
  valorOriginal   Decimal         @db.Decimal(10, 2)
  valorDesconto   Decimal?        @db.Decimal(10, 2)
  valorFinal      Decimal         @db.Decimal(10, 2)
  // Pagamento
  formaPagamento  FormaPagamento
  parcelas        Int? // null se Pix ou crédito à vista
  taxaMDR         Decimal         @db.Decimal(5, 2) // percentual aplicado
  statusPagamento StatusPagamento @default(NAO_PAGO)
  // Consignação (repasse ao fornecedor)
  valorRepasseDevido Decimal?     @db.Decimal(10, 2)
  valorRepasseFeito  Decimal?     @db.Decimal(10, 2)
  statusRepasse      StatusRepasse?
  dataRepasse        DateTime?
  // Cancelamento/Devolução
  cancelada        Boolean        @default(false)
  dataCancelamento DateTime?
  // Logística/Envio
  statusEnvio         StatusEnvio   @default(PENDENTE)
  dataEnvio           DateTime?
  codigoRastreio      String?
  tipoEntrega         String?       // RETIRADA_PESSOALMENTE, ENTREGA_RJ ou null para envio normal
  observacaoLogistica String?
  // NFe / Declaracao Fiscal
  valorDeclarar        Decimal?      @db.Decimal(10, 2)
  nfeDeclarada         Boolean       @default(false)
  // Datas
  dataVenda DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  pagamentos Pagamento[]

  @@index([clienteId])
  @@index([dataVenda])
  @@index([statusPagamento])
  @@index([cancelada])
  @@map("vendas")
}

// ============================================
// PAGAMENTOS (de vendas - cliente para nós)
// ============================================

model Pagamento {
  id        String   @id @default(cuid())
  vendaId   String
  venda     Venda    @relation(fields: [vendaId], references: [id], onDelete: Cascade)
  valor     Decimal  @db.Decimal(10, 2)
  data      DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([vendaId])
  @@map("pagamentos")
}

// ============================================
// PAGAMENTOS A FORNECEDORES (nós para fornecedor)
// ============================================

model PagamentoFornecedor {
  id        String   @id @default(cuid())
  pecaId    String
  peca      Peca     @relation(fields: [pecaId], references: [id], onDelete: Cascade)
  valor     Decimal  @db.Decimal(10, 2)
  data      DateTime @default(now())
  observacao String?
  createdAt DateTime @default(now())

  @@index([pecaId])
  @@index([data])
  @@map("pagamentos_fornecedor")
}

// ============================================
// CONFIGURAÇÕES DO SISTEMA
// ============================================

model Configuracao {
  id        String   @id @default(cuid())
  chave     String   @unique
  valor     String
  updatedAt DateTime @updatedAt

  @@map("configuracoes")
}

// ============================================
// UTENSÍLIOS DE EMBALAGEM
// ============================================

model Utensilio {
  id               String   @id @default(cuid())
  nome             String   @unique
  quantidade       Int      @default(0)
  quantidadeMinima Int      @default(5)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("utensilios")
}

// ============================================
// ALERTAS
// ============================================

model Alerta {
  id         String     @id @default(cuid())
  tipo       TipoAlerta
  titulo     String
  mensagem   String
  entidade   String? // Ex: "Peca", "Venda"
  entidadeId String? // ID relacionado
  lido       Boolean    @default(false)
  createdAt  DateTime   @default(now())

  @@index([lido])
  @@index([tipo])
  @@index([createdAt])
  @@map("alertas")
}
model User {
  id            String       @id
  name          String
  email         String
  emailVerified Boolean      @default(false)
  image         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  sessions      Session[]
  accounts      Account[]

  // Campos de negócio Mr. Chrono
  nivel        NivelAcesso  @default(FUNCIONARIO)
  ativo        Boolean      @default(true)
  ultimoAcesso DateTime?

  // Relações de negócio
  auditorias      Auditoria[]
  historicoStatus HistoricoStatus[]

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

// ============================================
// MÓDULO FINANCEIRO — PLANO DE CONTAS
// ============================================

model ContaContabil {
  id            String        @id @default(cuid())
  codigo        String        @unique // Ex: "1.1.1.01"
  nome          String // Ex: "Nubank (Pix)"
  tipo          TipoConta // GRUPO, SUBGRUPO, ANALITICA
  natureza      NaturezaConta // DEVEDORA ou CREDORA
  contaPaiId    String? // Referência hierárquica
  contaPai      ContaContabil?  @relation("HierarquiaConta", fields: [contaPaiId], references: [id])
  contasFilhas  ContaContabil[] @relation("HierarquiaConta")
  ordem         Int           @default(0) // Para ordenação dentro do nível
  ativa         Boolean       @default(true)
  sistematica   Boolean       @default(false) // true = conta criada pelo sistema, não pode ser excluída
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relações com lançamentos
  linhasDebito  LinhaLancamento[] @relation("ContaDebito")
  linhasCredito LinhaLancamento[] @relation("ContaCredito")

  // Relações com outros módulos
  contaBancaria    ContaBancaria?
  despesasRecorrentes DespesaRecorrente[]

  @@index([contaPaiId])
  @@index([codigo])
  @@map("contas_contabeis")
}

// ============================================
// MÓDULO FINANCEIRO — LANÇAMENTOS CONTÁBEIS
// ============================================

model Lancamento {
  id            String         @id @default(cuid())
  numero        Int            @default(autoincrement()) // Número sequencial
  data          DateTime // Data do lançamento (competência)
  descricao     String
  tipo          TipoLancamento
  recorrente    Boolean        @default(true) // false = não-recorrente (one-off)
  // Referências opcionais
  vendaId       String? // Se gerado por uma venda
  despesaRecorrenteId String? // Se gerado por despesa recorrente
  // Controle
  estornado     Boolean        @default(false)
  estornoDeId   String? // Referência ao lançamento original estornado
  userId        String // Quem criou
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relações
  linhas LinhaLancamento[]

  @@index([data])
  @@index([tipo])
  @@index([vendaId])
  @@index([despesaRecorrenteId])
  @@index([estornoDeId])
  @@map("lancamentos")
}

model LinhaLancamento {
  id             String        @id @default(cuid())
  lancamentoId   String
  lancamento     Lancamento    @relation(fields: [lancamentoId], references: [id], onDelete: Cascade)
  contaDebitoId  String
  contaDebito    ContaContabil @relation("ContaDebito", fields: [contaDebitoId], references: [id])
  contaCreditoId String
  contaCredito   ContaContabil @relation("ContaCredito", fields: [contaCreditoId], references: [id])
  valor          Decimal       @db.Decimal(10, 2)
  historico      String? // Descrição da linha

  @@index([lancamentoId])
  @@index([contaDebitoId])
  @@index([contaCreditoId])
  @@map("linhas_lancamento")
}

// ============================================
// MÓDULO FINANCEIRO — CONTAS BANCÁRIAS
// ============================================

model ContaBancaria {
  id              String        @id @default(cuid())
  nome            String // Ex: "Nubank PJ"
  banco           String // Ex: "Nubank"
  agencia         String?
  conta           String?
  contaContabilId String        @unique // Vinculada a uma conta do plano de contas
  contaContabil   ContaContabil @relation(fields: [contaContabilId], references: [id])
  saldoInicial    Decimal       @default(0) @db.Decimal(10, 2)
  ativa           Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relações
  transferenciasOrigem  TransferenciaBancaria[] @relation("ContaOrigem")
  transferenciasDestino TransferenciaBancaria[] @relation("ContaDestino")
  distribuicoes         DistribuicaoLucros[]
  antecipacoes          AntecipacaoRecebivel[]

  @@map("contas_bancarias")
}

// ============================================
// MÓDULO FINANCEIRO — DESPESAS RECORRENTES
// ============================================

model DespesaRecorrente {
  id              String                  @id @default(cuid())
  nome            String // Ex: "Contabilidade"
  valor           Decimal                 @db.Decimal(10, 2)
  contaContabilId String // Conta de despesa vinculada
  contaContabil   ContaContabil           @relation(fields: [contaContabilId], references: [id])
  status          StatusDespesaRecorrente  @default(ATIVA)
  diaReconhecimento Int                   @default(31) // Último dia do mês
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  @@index([status])
  @@map("despesas_recorrentes")
}

// ============================================
// MÓDULO FINANCEIRO — TRANSFERÊNCIAS BANCÁRIAS
// ============================================

model TransferenciaBancaria {
  id              String        @id @default(cuid())
  contaOrigemId   String
  contaOrigem     ContaBancaria @relation("ContaOrigem", fields: [contaOrigemId], references: [id])
  contaDestinoId  String
  contaDestino    ContaBancaria @relation("ContaDestino", fields: [contaDestinoId], references: [id])
  valor           Decimal       @db.Decimal(10, 2)
  data            DateTime
  descricao       String?
  lancamentoId    String? // Lançamento contábil gerado
  userId          String // Quem registrou
  createdAt       DateTime      @default(now())

  @@index([data])
  @@index([contaOrigemId])
  @@index([contaDestinoId])
  @@map("transferencias_bancarias")
}

// ============================================
// MÓDULO FINANCEIRO — DISTRIBUIÇÃO DE LUCROS
// ============================================

model DistribuicaoLucros {
  id              String        @id @default(cuid())
  socio           String // "Rafael" ou "João"
  valor           Decimal       @db.Decimal(10, 2)
  data            DateTime
  contaBancariaId String
  contaBancaria   ContaBancaria @relation(fields: [contaBancariaId], references: [id])
  lancamentoId    String? // Lançamento contábil gerado
  descricao       String?
  userId          String // Quem registrou
  createdAt       DateTime      @default(now())

  @@index([socio])
  @@index([data])
  @@map("distribuicoes_lucros")
}

// ============================================
// MÓDULO FINANCEIRO — ANTECIPAÇÃO DE RECEBÍVEIS
// ============================================

model AntecipacaoRecebivel {
  id              String        @id @default(cuid())
  data            DateTime
  valorBruto      Decimal       @db.Decimal(10, 2) // Valor total dos recebíveis
  taxaAntecipacao Decimal       @db.Decimal(5, 2) // Percentual da taxa
  valorTaxa       Decimal       @db.Decimal(10, 2) // Valor da taxa em R$
  valorLiquido    Decimal       @db.Decimal(10, 2) // Valor recebido (bruto - taxa)
  contaBancariaId String
  contaBancaria   ContaBancaria @relation(fields: [contaBancariaId], references: [id])
  lancamentoId    String? // Lançamento contábil gerado
  userId          String // Quem registrou
  createdAt       DateTime      @default(now())

  // Relação com vendas antecipadas
  vendas AntecipacaoVenda[]

  @@index([data])
  @@map("antecipacoes_recebiveis")
}

model AntecipacaoVenda {
  id              String              @id @default(cuid())
  antecipacaoId   String
  antecipacao     AntecipacaoRecebivel @relation(fields: [antecipacaoId], references: [id], onDelete: Cascade)
  vendaId         String
  valorAntecipado Decimal             @db.Decimal(10, 2)

  @@index([antecipacaoId])
  @@index([vendaId])
  @@map("antecipacao_vendas")
}

// ============================================
// CATÁLOGO PÚBLICO — EVENTOS/ANALYTICS
// ============================================

model CatalogoEvento {
  id         String   @id @default(cuid())
  tipo       String   // "pageview", "card_view", "click_interesse", "click_share", "filter_use"
  pecaId     String?
  deviceType String?  // "mobile", "desktop", "tablet"
  referrer   String?
  metadata   String?  // JSON
  createdAt  DateTime @default(now())

  @@index([tipo])
  @@index([pecaId])
  @@index([createdAt])
  @@map("catalogo_eventos")
}
