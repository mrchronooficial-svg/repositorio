// ============================================
// SISTEMA DE GESTÃO MR. CHRONO
// Schema Prisma - PostgreSQL
// ============================================

generator client {
  provider     = "prisma-client-js"
  output       = "./generated/client"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum NivelAcesso {
  ADMINISTRADOR
  SOCIO
  FUNCIONARIO
}

enum TipoPessoa {
  PESSOA_FISICA
  PESSOA_JURIDICA
}

enum OrigemTipo {
  COMPRA
  CONSIGNACAO
}

enum OrigemCanal {
  PESSOA_FISICA
  LEILAO_BRASIL
  EBAY
}

enum StatusPeca {
  DISPONIVEL
  EM_TRANSITO
  REVISAO
  VENDIDA
  DEFEITO
  PERDA
}

enum ScoreFornecedor {
  EXCELENTE
  BOM
  REGULAR
  RUIM
}

enum FormaPagamento {
  PIX
  CREDITO_VISTA
  CREDITO_PARCELADO
}

enum StatusPagamento {
  PAGO
  PARCIAL
  NAO_PAGO
}

enum StatusRepasse {
  FEITO
  PARCIAL
  PENDENTE
}

enum TipoAlerta {
  ESTOQUE_BAIXO
  RELOJOEIRO_DEMORADO
  REPASSE_PENDENTE
}

enum StatusEnvio {
  PENDENTE
  ENVIADO
  ENTREGUE
}

// ============================================
// AUDITORIA
// ============================================

model Auditoria {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  acao       String // CRIAR, EDITAR, EXCLUIR, etc.
  entidade   String // PECA, VENDA, CLIENTE, etc.
  entidadeId String? // ID do registro afetado
  detalhes   String? // JSON com dados adicionais
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entidade])
  @@index([createdAt])
  @@map("auditorias")
}

// ============================================
// FORNECEDORES
// ============================================

model Fornecedor {
  id          String           @id @default(cuid())
  tipo        TipoPessoa
  nome        String
  cpfCnpj     String           @unique
  telefone    String
  email       String?
  // Endereço
  cep         String
  rua         String
  numero      String
  complemento String?
  bairro      String
  cidade      String
  estado      String           @db.Char(2)
  score       ScoreFornecedor?
  arquivado   Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relações
  pecas Peca[]

  @@index([cpfCnpj])
  @@index([arquivado])
  @@map("fornecedores")
}

// ============================================
// CLIENTES
// ============================================

model Cliente {
  id             String     @id @default(cuid())
  tipo           TipoPessoa
  nome           String
  cpfCnpj        String     @unique
  dataNascimento DateTime? // Obrigatório se PF
  telefone       String
  email          String?
  // Endereço
  cep            String
  rua            String
  numero         String
  complemento    String?
  bairro         String
  cidade         String
  estado         String     @db.Char(2)
  arquivado      Boolean    @default(false)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Relações
  vendas Venda[]

  @@index([cpfCnpj])
  @@index([arquivado])
  @@map("clientes")
}

// ============================================
// PEÇAS (ESTOQUE)
// ============================================

model Peca {
  id               String      @id @default(cuid())
  // SKU
  sku              String      @unique
  skuBase          String // SKU original (sem sufixo de devolução)
  numeroDevolucoes Int         @default(0)
  // Dados do relógio
  marca            String
  modelo           String
  ano              Int?
  tamanhoCaixa     Float // em mm
  materialCaixa    String?
  materialPulseira String?
  // Valores
  valorCompra      Decimal     @db.Decimal(10, 2)
  valorEstimadoVenda Decimal   @db.Decimal(10, 2)
  // Origem
  origemTipo       OrigemTipo
  origemCanal      OrigemCanal?
  valorRepasse     Decimal?    @db.Decimal(10, 2) // Para consignação
  // Pagamento ao fornecedor (para compras diretas)
  statusPagamentoFornecedor StatusPagamento @default(NAO_PAGO)
  valorPagoFornecedor       Decimal         @default(0) @db.Decimal(10, 2)
  dataPagamentoFornecedor   DateTime?       // Data do último pagamento
  // Status e localização
  status           StatusPeca  @default(EM_TRANSITO)
  localizacao      String      @default("Fornecedor")
  // Controle
  arquivado        Boolean     @default(false)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  // Relações
  fornecedorId           String
  fornecedor             Fornecedor              @relation(fields: [fornecedorId], references: [id])
  fotos                  Foto[]
  historicoStatus        HistoricoStatus[]
  venda                  Venda?
  pagamentosFornecedor   PagamentoFornecedor[]

  @@index([sku])
  @@index([status])
  @@index([localizacao])
  @@index([arquivado])
  @@index([fornecedorId])
  @@index([statusPagamentoFornecedor])
  @@map("pecas")
}

// ============================================
// FOTOS DAS PEÇAS
// ============================================

model Foto {
  id        String   @id @default(cuid())
  url       String
  ordem     Int      @default(0)
  pecaId    String
  peca      Peca     @relation(fields: [pecaId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([pecaId])
  @@map("fotos")
}

// ============================================
// HISTÓRICO DE STATUS DAS PEÇAS
// ============================================

model HistoricoStatus {
  id                  String      @id @default(cuid())
  pecaId              String
  peca                Peca        @relation(fields: [pecaId], references: [id], onDelete: Cascade)
  statusAnterior      StatusPeca?
  statusNovo          StatusPeca
  localizacaoAnterior String?
  localizacaoNova     String?
  userId              String?
  user                User?       @relation(fields: [userId], references: [id])
  createdAt           DateTime    @default(now())

  @@index([pecaId])
  @@index([createdAt])
  @@map("historico_status")
}

// ============================================
// VENDAS
// ============================================

model Venda {
  id              String          @id @default(cuid())
  // Peça vendida (1:1)
  pecaId          String          @unique
  peca            Peca            @relation(fields: [pecaId], references: [id])
  // Cliente
  clienteId       String
  cliente         Cliente         @relation(fields: [clienteId], references: [id])
  // Valores
  valorOriginal   Decimal         @db.Decimal(10, 2)
  valorDesconto   Decimal?        @db.Decimal(10, 2)
  valorFinal      Decimal         @db.Decimal(10, 2)
  // Pagamento
  formaPagamento  FormaPagamento
  parcelas        Int? // null se Pix ou crédito à vista
  taxaMDR         Decimal         @db.Decimal(5, 2) // percentual aplicado
  statusPagamento StatusPagamento @default(NAO_PAGO)
  // Consignação (repasse ao fornecedor)
  valorRepasseDevido Decimal?     @db.Decimal(10, 2)
  valorRepasseFeito  Decimal?     @db.Decimal(10, 2)
  statusRepasse      StatusRepasse?
  dataRepasse        DateTime?
  // Cancelamento/Devolução
  cancelada        Boolean        @default(false)
  dataCancelamento DateTime?
  // Logística/Envio
  statusEnvio         StatusEnvio   @default(PENDENTE)
  dataEnvio           DateTime?
  codigoRastreio      String?
  tipoEntrega         String?       // RETIRADA_PESSOALMENTE, ENTREGA_RJ ou null para envio normal
  observacaoLogistica String?
  // NFe / Declaracao Fiscal
  valorDeclarar        Decimal?      @db.Decimal(10, 2)
  nfeDeclarada         Boolean       @default(false)
  // Datas
  dataVenda DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  pagamentos Pagamento[]

  @@index([clienteId])
  @@index([dataVenda])
  @@index([statusPagamento])
  @@index([cancelada])
  @@map("vendas")
}

// ============================================
// PAGAMENTOS (de vendas - cliente para nós)
// ============================================

model Pagamento {
  id        String   @id @default(cuid())
  vendaId   String
  venda     Venda    @relation(fields: [vendaId], references: [id], onDelete: Cascade)
  valor     Decimal  @db.Decimal(10, 2)
  data      DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([vendaId])
  @@map("pagamentos")
}

// ============================================
// PAGAMENTOS A FORNECEDORES (nós para fornecedor)
// ============================================

model PagamentoFornecedor {
  id        String   @id @default(cuid())
  pecaId    String
  peca      Peca     @relation(fields: [pecaId], references: [id], onDelete: Cascade)
  valor     Decimal  @db.Decimal(10, 2)
  data      DateTime @default(now())
  observacao String?
  createdAt DateTime @default(now())

  @@index([pecaId])
  @@index([data])
  @@map("pagamentos_fornecedor")
}

// ============================================
// CONFIGURAÇÕES DO SISTEMA
// ============================================

model Configuracao {
  id        String   @id @default(cuid())
  chave     String   @unique
  valor     String
  updatedAt DateTime @updatedAt

  @@map("configuracoes")
}

// ============================================
// UTENSÍLIOS DE EMBALAGEM
// ============================================

model Utensilio {
  id               String   @id @default(cuid())
  nome             String   @unique
  quantidade       Int      @default(0)
  quantidadeMinima Int      @default(5)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("utensilios")
}

// ============================================
// ALERTAS
// ============================================

model Alerta {
  id         String     @id @default(cuid())
  tipo       TipoAlerta
  titulo     String
  mensagem   String
  entidade   String? // Ex: "Peca", "Venda"
  entidadeId String? // ID relacionado
  lido       Boolean    @default(false)
  createdAt  DateTime   @default(now())

  @@index([lido])
  @@index([tipo])
  @@index([createdAt])
  @@map("alertas")
}
model User {
  id            String       @id
  name          String
  email         String
  emailVerified Boolean      @default(false)
  image         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  sessions      Session[]
  accounts      Account[]

  // Campos de negócio Mr. Chrono
  nivel        NivelAcesso  @default(FUNCIONARIO)
  ativo        Boolean      @default(true)
  ultimoAcesso DateTime?

  // Relações de negócio
  auditorias      Auditoria[]
  historicoStatus HistoricoStatus[]

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}
